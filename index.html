<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --card:#0E1629cc;
      --stroke:#ffffff1f;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --blue:#3b82f6;
      --blue2:#60a5fa;
      --red:#ef4444;
      --green:#22c55e;
      --shadow: 0 30px 80px rgba(0,0,0,.55);
      --radius: 18px;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(800px 700px at 50% 90%, rgba(99,102,241,.15), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 24px;
    }

    .card{
      width: min(460px, 100%);
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .header{
      padding: 22px 22px 10px 22px;
      display:flex;
      gap:14px;
      align-items:center;
    }
    .logo{
      width: 44px; height: 44px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(96,165,250,.9), rgba(59,130,246,.3) 55%, rgba(0,0,0,0) 65%),
        linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 30px rgba(59,130,246,.15);
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .sub{
      margin: 3px 0 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .content{
      padding: 0 22px 22px 22px;
    }

    .notice{
      margin: 10px 0 14px 0;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      background: rgba(255,255,255,.04);
    }

    .row{
      display:grid;
      gap: 10px;
      margin-top: 14px;
    }

    label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: -4px;
    }

    .field{
      position:relative;
    }

    input{
      width: 100%;
      padding: 12px 44px 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.15);
    }

    .toggle{
      position:absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }

    .strength{
      margin-top: 6px;
      display:flex;
      gap: 8px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .bar{
      flex:1;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid var(--stroke);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(239,68,68,.9), rgba(59,130,246,.9), rgba(34,197,94,.9));
      transition: width .2s ease;
    }

    .actions{
      margin-top: 16px;
      display:grid;
      gap: 10px;
    }

    button.primary{
      width:100%;
      padding: 12px 14px;
      border: 0;
      border-radius: 14px;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(96,165,250,.95), rgba(59,130,246,.95));
      color: #071022;
      font-weight: 750;
      letter-spacing: .2px;
      box-shadow: 0 18px 40px rgba(59,130,246,.25);
      transition: transform .08s ease, filter .2s ease;
    }
    button.primary:active{ transform: translateY(1px) scale(.995); }
    button.primary:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.8);
    }

    .secondary{
      background: transparent;
      border: 1px solid var(--stroke);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
    }

    .msg{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      display:none;
      white-space: pre-wrap;
    }
    .msg.error{
      display:block;
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color: #fecaca;
    }
    .msg.ok{
      display:block;
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.08);
      color: #bbf7d0;
    }
    .msg.info{
      display:block;
      color: var(--muted);
    }

    .footer{
      padding: 14px 22px 18px 22px;
      border-top: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    a{ color: var(--blue2); text-decoration: none; }
    a:hover{ text-decoration: underline; }
  </style>
</head>

<body>
  <div class="card" role="main" aria-label="Reset Password">
    <div class="header">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Reset your password</h1>
        <p class="sub">Enter a new password for your account. This page works only from the reset email link.</p>
      </div>
    </div>

    <div class="content">
      <div class="notice" id="notice">
        If you opened this page directly (not from the email), it will not have a recovery session.
      </div>

      <div class="row">
        <label for="password">New password</label>
        <div class="field">
          <input id="password" type="password" placeholder="At least 6 characters" autocomplete="new-password" />
          <span class="toggle" id="toggle1">Show</span>
        </div>

        <label for="confirm">Confirm new password</label>
        <div class="field">
          <input id="confirm" type="password" placeholder="Repeat password" autocomplete="new-password" />
          <span class="toggle" id="toggle2">Show</span>
        </div>

        <div class="strength">
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div id="strengthText">Strength: —</div>
        </div>

        <div class="actions">
          <button class="primary" id="btn" onclick="resetPassword()">Update password</button>
          <button class="secondary" onclick="window.close()">Close</button>
        </div>

        <div class="msg info" id="msg"></div>
      </div>
    </div>

    <div class="footer">
      <span>Powered by Supabase recovery session</span>
      <span><a href="#" onclick="location.reload(); return false;">Refresh</a></span>
    </div>
  </div>

<script>
  //  real Supabase Project URL:
  const SUPABASE_URL = "https://gdvhiudodnqdqhkyghsk.supabase.co";

  // anon/publishable key
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkdmhpdWRvZG5xZHFoa3lnaHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMTI2MTksImV4cCI6MjA2NDU4ODYxOX0.p9P-Hv4r-C9eZU3Dz-kX9U2iv8PUAKaUU5qZGPMJ844";

  const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const msg = $("msg");
  const btn = $("btn");
  const pass = $("password");
  const confirm = $("confirm");
  const fill = $("fill");
  const strengthText = $("strengthText");

  function setMsg(type, text){
    msg.className = "msg " + type;
    msg.style.display = "block";
    msg.textContent = text;
  }

  function clearMsg(){
    msg.style.display = "none";
    msg.textContent = "";
    msg.className = "msg info";
  }

  function togglePassword(input, toggleEl){
    const isPw = input.type === "password";
    input.type = isPw ? "text" : "password";
    toggleEl.textContent = isPw ? "Hide" : "Show";
  }

  $("toggle1").addEventListener("click", () => togglePassword(pass, $("toggle1")));
  $("toggle2").addEventListener("click", () => togglePassword(confirm, $("toggle2")));

  function strengthScore(p){
    // very simple score (good enough for UI)
    let s = 0;
    if (!p) return 0;
    if (p.length >= 6) s++;
    if (p.length >= 10) s++;
    if (/[A-Z]/.test(p)) s++;
    if (/[0-9]/.test(p)) s++;
    if (/[^A-Za-z0-9]/.test(p)) s++;
    return Math.min(5, s);
  }

  function updateStrength(){
    const p = pass.value || "";
    const s = strengthScore(p);
    const pct = (s / 5) * 100;
    fill.style.width = pct + "%";
    const label = ["—", "Weak", "OK", "Good", "Strong", "Very strong"][s];
    strengthText.textContent = "Strength: " + label;
  }

  pass.addEventListener("input", updateStrength);
  updateStrength();

  // Optional: show whether we likely have a recovery session.
  // Many Supabase recovery links put tokens in the URL fragment (#...).
  // We don't need to parse it manually here—supabase-js can pick it up.
  (async () => {
    try {
      const { data } = await supabase.auth.getSession();
      if (data && data.session) {
        $("notice").textContent = "✅ Recovery session detected. You can set a new password.";
      } else {
        $("notice").textContent = "⚠️ No session yet. Make sure you opened this from the reset email link.";
      }
    } catch {
      // ignore
    }
  })();

  async function resetPassword(){
    clearMsg();
    const p1 = pass.value || "";
    const p2 = confirm.value || "";

    if (p1.length < 6){
      setMsg("error", "Password must be at least 6 characters.");
      return;
    }
    if (p1 !== p2){
      setMsg("error", "Passwords do not match.");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Updating…";

    try {
      // ✅ This works when the user arrived from the Supabase recovery email link
      const { error } = await supabase.auth.updateUser({ password: p1 });

      if (error){
        setMsg("error", error.message + "\n\nTip: If you opened this page directly, request a new reset email.");
      } else {
        setMsg("ok", "✅ Password updated successfully!\nYou can close this page and log in with your new password.");
      }
    } catch (e){
      setMsg("error", "Unexpected error. " + (e?.message || String(e)));
    } finally {
      btn.disabled = false;
      btn.textContent = "Update password";
    }
  }
</script>
</body>
</html>
